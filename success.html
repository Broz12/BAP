<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Success | MLBB Pro Top-Up</title>

    <meta name="supabase-url" content="" />
    <meta name="supabase-anon-key" content="" />
    <meta name="stripe-publishable-key" content="" />
    <meta name="app-base-url" content="" />
    <meta name="admin-whatsapp-number" content="" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/style.css" />
    <script src="./js/runtime-config.js"></script>
  </head>
  <body>
    <header class="navbar">
      <div class="inner">
        <a href="index.html" class="brand">
          <span class="brand-mark">â—†</span>
          <span>MLBB Pro Top-Up</span>
        </a>
        <nav class="nav-links">
          <a data-nav-link href="index.html">Home</a>
          <a data-nav-link href="topup.html">Top-Up</a>
          <a data-nav-link href="dashboard.html">Dashboard</a>
          <a data-nav-link href="admin.html">Admin</a>
          <button data-logout class="btn secondary">Logout</button>
        </nav>
      </div>
    </header>

    <main>
      <section class="section" data-animate>
        <article class="glass card" style="max-width: 760px; margin: 0 auto">
          <h1 style="margin-top: 0; font-family: Orbitron, sans-serif">Payment Received</h1>
          <p class="label">
            We are verifying your payment and updating your order. Keep this page open for a few seconds if status is pending.
          </p>

          <div class="grid two">
            <div class="card">
              <p class="label">Stripe Session</p>
              <p id="sessionValue" style="margin: 0; font-weight: 700">-</p>
            </div>
            <div class="card">
              <p class="label">Order Status</p>
              <p id="orderStatusValue" style="margin: 0; font-weight: 700">Pending verification</p>
            </div>
          </div>

          <div class="inline-actions" style="margin-top: 1rem">
            <a href="dashboard.html" class="btn">Go to Dashboard</a>
            <button id="downloadInvoiceBtn" class="btn secondary hidden">Download Invoice</button>
          </div>
        </article>
      </section>
    </main>

    <footer class="footer-note">
      <p><strong>Disclaimer:</strong> This website is not affiliated with Moonton or Mobile Legends.</p>
    </footer>

    <script type="module">
      import { supabase } from "./supabase/config.js";
      import { initBasePage, showToast } from "./js/app.js";

      const orderStatusValue = document.getElementById("orderStatusValue");
      const sessionValue = document.getElementById("sessionValue");
      const invoiceBtn = document.getElementById("downloadInvoiceBtn");

      const ready = await initBasePage({ requireAuth: true });
      if (!ready) {
        orderStatusValue.textContent = "App config missing. Update js/runtime-config.js and redeploy.";
        return;
      }

      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get("session_id");
      sessionValue.textContent = sessionId || "Missing";

      if (!sessionId) {
        orderStatusValue.textContent = "Session ID not found in URL.";
      }

      let attempts = 0;
      const maxAttempts = 18;

      async function checkOrder() {
        attempts += 1;
        const { data, error } = await supabase
          .from("orders")
          .select("id, payment_status, order_status, invoice_path")
          .eq("stripe_session_id", sessionId)
          .order("created_at", { ascending: false })
          .limit(1)
          .maybeSingle();

        if (error) {
          throw error;
        }

        if (!data) {
          orderStatusValue.textContent = "Waiting for webhook confirmation...";
          if (attempts < maxAttempts) {
            window.setTimeout(checkOrder, 5000);
          } else {
            orderStatusValue.textContent =
              "No order linked to this session yet. If this was a wallet deposit, check dashboard balance in 1-2 minutes.";
          }
          return;
        }

        orderStatusValue.textContent = `${data.payment_status} / ${data.order_status}`;

        if (data.invoice_path) {
          invoiceBtn.classList.remove("hidden");
          invoiceBtn.onclick = async () => {
            const { data: signed, error: signErr } = await supabase.storage.from("invoices").createSignedUrl(data.invoice_path, 120);
            if (signErr) {
              showToast(signErr.message, "error");
              return;
            }
            window.open(signed.signedUrl, "_blank", "noopener,noreferrer");
          };
        }

        if (data.payment_status !== "paid" && attempts < maxAttempts) {
          window.setTimeout(checkOrder, 5000);
        }
      }

      if (sessionId) {
        checkOrder().catch((error) => {
          showToast(error.message || "Unable to verify order.", "error");
        });
      }
    </script>
  </body>
</html>
